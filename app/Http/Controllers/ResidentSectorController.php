<?php

namespace App\Http\Controllers;

use App\Models\ActivityLog;
use App\Models\Banragay;
use App\Models\ResidentSector;
use App\Models\Resident;
use App\Models\Sector;
use App\Http\Requests\StoreResidentSectorRequest;
use App\Http\Requests\UpdateResidentSectorRequest;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Brian2694\Toastr\Facades\Toastr;
use Illuminate\Support\Facades\Auth;
use Yajra\Datatables\Datatables;
use Illuminate\Support\Facades\Session;

class ResidentSectorController extends Controller
{
    public function __construct()
    {
        //Array portion is for you to except pages.
        //$this->middleware('auth', ['except' => ['index', 'show']]);
        $this->middleware('auth');
    }

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */

    public function index()
    {
    return view('sectors.index');
    }

    public function sectorNav()
    {
        $sector = Sector::all();
        return view('resident_sector.nav_tab', compact('sector'));
    }

    public function listSector(Request $request, $sector)
    {
        date_default_timezone_set('Asia/Manila');

        if(!Auth::guest())
        {
            if (!Session::has('locked'))
            {
                $sector = Sector::all();
                $sector_id = 20220001;
                $sector = "Family Heads";
                //Family Heads
                if(Auth::user()->usertype == 'admin' || Auth::user()->usertype == 'secretary')
                {  
                    $res = DB::table('residents')
                                ->join('barangays', 'barangays.id', '=', 'residents.barangay_id')
                                ->join('resident_sectors', 'residents.id', '=', 'resident_sectors.resident_id')
                                ->join('sectors', 'sectors.id', '=', 'resident_sectors.sector_id')
                                ->where('sectors.id', '=', $sector_id)
                                ->select(
                                    'residents.*', 
                                    'residents.id as resID', 
                                    'barangays.*', 
                                    'barangays.barangay as brgy',
                                    'resident_sectors.id as resSec_id', 'sectors.id as sector_id', 
                                    DB::raw('(year(curdate())-year(residents.birth_date)) as age, DATE_FORMAT(residents.birth_date, "%M %d, %Y") as birth'))
                                    ->get();
                }
                elseif(Auth::user()->usertype == 'barangay')
                {
                    $res = DB::table('residents')
                                ->join('barangays', 'barangays.id', '=', 'residents.barangay_id')
                                ->join('resident_sectors', 'residents.id', '=', 'resident_sectors.resident_id')
                                ->join('sectors', 'sectors.id', '=', 'resident_sectors.sector_id')
                                ->where('barangays.barangay', auth()->user()->barangay)
                                ->where('resident_sectors.sector_id', $sector_id)
                                ->select(
                                    'residents.*', 
                                    'residents.id as resID', 
                                    'barangays.*', 
                                    'barangays.barangay as brgy',
                                    'resident_sectors.id as resSec_id', 'sectors.id as sector_id', 
                                    DB::raw('(year(curdate())-year(residents.birth_date)) as age, DATE_FORMAT(residents.birth_date, "%M %d, %Y") as birth'))
                                    ->get();
                }
                else
                {
                    return view('errors.401');
                }
                return view ('resident_sector.index', compact('res', 'sector_id', 'sector'));
            }
            else
            {
                return redirect('/locked');
            }
        }
        else
        {
            return redirect()->guest('login');
        }
    }

    
    //1 - Family Head, 2 - Farmer, 3 - Household Head, 4 - OFW, 5 - Out Of School Youth, 6 - PWD, 7 - Senior Citizen, 8 - Solo Parent, 9 - 4Ps, 10 - Business Owner
    //1 - Family Head
    public function indexFamilyHead(Request $request)
    {
        date_default_timezone_set('Asia/Manila');

        if(!Auth::guest())
        {
            if (!Session::has('locked'))
            {
                $sector_id = 20220001;
                $sector = "Family Heads";
                //Family Heads
                if(Auth::user()->usertype == 'admin' || Auth::user()->usertype == 'secretary')
                {  
                    $res = DB::table('residents')
                                ->join('barangays', 'barangays.id', '=', 'residents.barangay_id')
                                ->join('resident_sectors', 'residents.id', '=', 'resident_sectors.resident_id')
                                ->join('sectors', 'sectors.id', '=', 'resident_sectors.sector_id')
                                ->where('sectors.id', '=', $sector_id)
                                ->select(
                                    'residents.*', 
                                    'residents.id as resID', 
                                    'barangays.*', 
                                    'barangays.barangay as brgy',
                                    'resident_sectors.id as resSec_id', 'sectors.id as sector_id', 
                                    DB::raw('(year(curdate())-year(residents.birth_date)) as age, DATE_FORMAT(residents.birth_date, "%M %d, %Y") as birth'))
                                    ->get();
                }
                elseif(Auth::user()->usertype == 'barangay')
                {
                    $res = DB::table('residents')
                                ->join('barangays', 'barangays.id', '=', 'residents.barangay_id')
                                ->join('resident_sectors', 'residents.id', '=', 'resident_sectors.resident_id')
                                ->join('sectors', 'sectors.id', '=', 'resident_sectors.sector_id')
                                ->where('barangays.barangay', auth()->user()->barangay)
                                ->where('resident_sectors.sector_id', $sector_id)
                                ->select(
                                    'residents.*', 
                                    'residents.id as resID', 
                                    'barangays.*', 
                                    'barangays.barangay as brgy',
                                    'resident_sectors.id as resSec_id', 'sectors.id as sector_id', 
                                    DB::raw('(year(curdate())-year(residents.birth_date)) as age, DATE_FORMAT(residents.birth_date, "%M %d, %Y") as birth'))
                                    ->get();
                }
                else
                {
                    return view('errors.401');
                }
                return view ('resident_sector.index', compact('res', 'sector_id', 'sector'));
            }
            else
            {
                return redirect('/locked');
            }
        }
        else
        {
            return redirect()->guest('login');
        }
    }

    public function indexHouseholdHead(Request $request)
    {
        date_default_timezone_set('Asia/Manila');
        if(!Auth::guest())
        {
            if (!Session::has('locked'))
            {
                $sector_id = 20220002;
                $sector = "Household Heads";
                //Family Heads
                if(Auth::user()->usertype == 'admin' || Auth::user()->usertype == 'secretary')
                {  
                    $res = DB::table('residents')
                                ->join('barangays', 'barangays.id', '=', 'residents.barangay_id')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           